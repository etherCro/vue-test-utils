<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>教程 | Vue Test Utils</title>
    <meta name="description" content="测试 Vue 组件的实用工具">
    <link rel="icon" href="/favicon.png">
    
    <link rel="preload" href="/assets/css/0.styles.6fddc57d.css" as="style"><link rel="preload" href="/assets/js/app.1329aa21.js" as="script"><link rel="preload" href="/assets/js/254.5765c3f9.js" as="script"><link rel="prefetch" href="/assets/js/10.29680c27.js"><link rel="prefetch" href="/assets/js/100.04f6aa34.js"><link rel="prefetch" href="/assets/js/101.0faed46e.js"><link rel="prefetch" href="/assets/js/102.5adbd4f8.js"><link rel="prefetch" href="/assets/js/103.ab03605d.js"><link rel="prefetch" href="/assets/js/104.853529ed.js"><link rel="prefetch" href="/assets/js/105.894916b1.js"><link rel="prefetch" href="/assets/js/106.15048092.js"><link rel="prefetch" href="/assets/js/107.75338401.js"><link rel="prefetch" href="/assets/js/108.380e49c8.js"><link rel="prefetch" href="/assets/js/109.eff80191.js"><link rel="prefetch" href="/assets/js/11.48ee5d3b.js"><link rel="prefetch" href="/assets/js/110.c8a76652.js"><link rel="prefetch" href="/assets/js/111.5ea0f65d.js"><link rel="prefetch" href="/assets/js/112.4ad98b3d.js"><link rel="prefetch" href="/assets/js/113.ecaf59db.js"><link rel="prefetch" href="/assets/js/114.d0f18bce.js"><link rel="prefetch" href="/assets/js/115.325a0839.js"><link rel="prefetch" href="/assets/js/116.3ad73770.js"><link rel="prefetch" href="/assets/js/117.4e280aa7.js"><link rel="prefetch" href="/assets/js/118.b4efe52b.js"><link rel="prefetch" href="/assets/js/119.9ab9e340.js"><link rel="prefetch" href="/assets/js/12.38da1e11.js"><link rel="prefetch" href="/assets/js/120.e2fb2daa.js"><link rel="prefetch" href="/assets/js/121.6f844508.js"><link rel="prefetch" href="/assets/js/122.ff2feb8e.js"><link rel="prefetch" href="/assets/js/123.9654b63b.js"><link rel="prefetch" href="/assets/js/124.8058bc12.js"><link rel="prefetch" href="/assets/js/125.15ac88b0.js"><link rel="prefetch" href="/assets/js/126.4919d1ce.js"><link rel="prefetch" href="/assets/js/127.ba415b0c.js"><link rel="prefetch" href="/assets/js/128.3b5a1f15.js"><link rel="prefetch" href="/assets/js/129.08fff316.js"><link rel="prefetch" href="/assets/js/13.2467e4d3.js"><link rel="prefetch" href="/assets/js/130.6177b120.js"><link rel="prefetch" href="/assets/js/131.3662683e.js"><link rel="prefetch" href="/assets/js/132.0a99c1ca.js"><link rel="prefetch" href="/assets/js/133.57ac58f3.js"><link rel="prefetch" href="/assets/js/134.68205139.js"><link rel="prefetch" href="/assets/js/135.62d0a716.js"><link rel="prefetch" href="/assets/js/136.1ba9fe2b.js"><link rel="prefetch" href="/assets/js/137.c002612a.js"><link rel="prefetch" href="/assets/js/138.104f9872.js"><link rel="prefetch" href="/assets/js/139.9937ea4d.js"><link rel="prefetch" href="/assets/js/14.09d9e43c.js"><link rel="prefetch" href="/assets/js/140.fc69423e.js"><link rel="prefetch" href="/assets/js/141.4278b1d2.js"><link rel="prefetch" href="/assets/js/142.02f17f28.js"><link rel="prefetch" href="/assets/js/143.edc98244.js"><link rel="prefetch" href="/assets/js/144.84ff6903.js"><link rel="prefetch" href="/assets/js/145.c4300d0b.js"><link rel="prefetch" href="/assets/js/146.97b8c42b.js"><link rel="prefetch" href="/assets/js/147.b45db334.js"><link rel="prefetch" href="/assets/js/148.29cc9dac.js"><link rel="prefetch" href="/assets/js/149.20083aaa.js"><link rel="prefetch" href="/assets/js/15.768aa9d0.js"><link rel="prefetch" href="/assets/js/150.5ffb1fda.js"><link rel="prefetch" href="/assets/js/151.0ef482d4.js"><link rel="prefetch" href="/assets/js/152.a7b342f2.js"><link rel="prefetch" href="/assets/js/153.d66cadd0.js"><link rel="prefetch" href="/assets/js/154.cf1b0ac0.js"><link rel="prefetch" href="/assets/js/155.17b5e561.js"><link rel="prefetch" href="/assets/js/156.baf08bf3.js"><link rel="prefetch" href="/assets/js/157.d4ada28a.js"><link rel="prefetch" href="/assets/js/158.ebb753a6.js"><link rel="prefetch" href="/assets/js/159.91678ded.js"><link rel="prefetch" href="/assets/js/16.5bdeee2c.js"><link rel="prefetch" href="/assets/js/160.acc3bfd8.js"><link rel="prefetch" href="/assets/js/161.b80960b6.js"><link rel="prefetch" href="/assets/js/162.5309d0c0.js"><link rel="prefetch" href="/assets/js/163.1f1af0fa.js"><link rel="prefetch" href="/assets/js/164.9aa31800.js"><link rel="prefetch" href="/assets/js/165.67089a2d.js"><link rel="prefetch" href="/assets/js/166.e4381a59.js"><link rel="prefetch" href="/assets/js/167.e061b4be.js"><link rel="prefetch" href="/assets/js/168.1622ee8d.js"><link rel="prefetch" href="/assets/js/169.a74fa5ec.js"><link rel="prefetch" href="/assets/js/17.6a9184c3.js"><link rel="prefetch" href="/assets/js/170.dbcbf8ff.js"><link rel="prefetch" href="/assets/js/171.a3b8a4f9.js"><link rel="prefetch" href="/assets/js/172.de198904.js"><link rel="prefetch" href="/assets/js/173.3fd7eba4.js"><link rel="prefetch" href="/assets/js/174.125158bf.js"><link rel="prefetch" href="/assets/js/175.5773a31e.js"><link rel="prefetch" href="/assets/js/176.fcbaf7d1.js"><link rel="prefetch" href="/assets/js/177.e13c54ed.js"><link rel="prefetch" href="/assets/js/178.461c97de.js"><link rel="prefetch" href="/assets/js/179.18556f26.js"><link rel="prefetch" href="/assets/js/18.4739f596.js"><link rel="prefetch" href="/assets/js/180.d8162130.js"><link rel="prefetch" href="/assets/js/181.3e030696.js"><link rel="prefetch" href="/assets/js/182.0d333584.js"><link rel="prefetch" href="/assets/js/183.2c46f0c1.js"><link rel="prefetch" href="/assets/js/184.59f17e66.js"><link rel="prefetch" href="/assets/js/185.7925ce4a.js"><link rel="prefetch" href="/assets/js/186.3acf0daf.js"><link rel="prefetch" href="/assets/js/187.96e6dcdd.js"><link rel="prefetch" href="/assets/js/188.8cf3b309.js"><link rel="prefetch" href="/assets/js/189.0798f541.js"><link rel="prefetch" href="/assets/js/19.30d0c826.js"><link rel="prefetch" href="/assets/js/190.66cb08eb.js"><link rel="prefetch" href="/assets/js/191.452d56c4.js"><link rel="prefetch" href="/assets/js/192.65b42183.js"><link rel="prefetch" href="/assets/js/193.702243fe.js"><link rel="prefetch" href="/assets/js/194.cc073482.js"><link rel="prefetch" href="/assets/js/195.48a7245e.js"><link rel="prefetch" href="/assets/js/196.feae8953.js"><link rel="prefetch" href="/assets/js/197.70d94a78.js"><link rel="prefetch" href="/assets/js/198.99f9b3d3.js"><link rel="prefetch" href="/assets/js/199.d88b8456.js"><link rel="prefetch" href="/assets/js/20.8c56e86c.js"><link rel="prefetch" href="/assets/js/200.80ba7b94.js"><link rel="prefetch" href="/assets/js/201.aad9c773.js"><link rel="prefetch" href="/assets/js/202.3402b8a7.js"><link rel="prefetch" href="/assets/js/203.8a011962.js"><link rel="prefetch" href="/assets/js/204.db458acf.js"><link rel="prefetch" href="/assets/js/205.f88837dd.js"><link rel="prefetch" href="/assets/js/206.97b6ee18.js"><link rel="prefetch" href="/assets/js/207.2175c20a.js"><link rel="prefetch" href="/assets/js/208.4d4fc400.js"><link rel="prefetch" href="/assets/js/209.2b8f6d9c.js"><link rel="prefetch" href="/assets/js/21.b1fca836.js"><link rel="prefetch" href="/assets/js/210.9fbe7e4f.js"><link rel="prefetch" href="/assets/js/211.b9d49f94.js"><link rel="prefetch" href="/assets/js/212.03bddb3f.js"><link rel="prefetch" href="/assets/js/213.ce98d5fc.js"><link rel="prefetch" href="/assets/js/214.dc7073f3.js"><link rel="prefetch" href="/assets/js/215.2afd5e1e.js"><link rel="prefetch" href="/assets/js/216.544b7ade.js"><link rel="prefetch" href="/assets/js/217.b067af8d.js"><link rel="prefetch" href="/assets/js/218.377bede2.js"><link rel="prefetch" href="/assets/js/219.27f6f18c.js"><link rel="prefetch" href="/assets/js/22.092854f5.js"><link rel="prefetch" href="/assets/js/220.68ba890e.js"><link rel="prefetch" href="/assets/js/221.ff994cf8.js"><link rel="prefetch" href="/assets/js/222.3c530c59.js"><link rel="prefetch" href="/assets/js/223.543c93de.js"><link rel="prefetch" href="/assets/js/224.134c6c7a.js"><link rel="prefetch" href="/assets/js/225.674555de.js"><link rel="prefetch" href="/assets/js/226.fec2925b.js"><link rel="prefetch" href="/assets/js/227.10c8d245.js"><link rel="prefetch" href="/assets/js/228.fd07045c.js"><link rel="prefetch" href="/assets/js/229.c0feb073.js"><link rel="prefetch" href="/assets/js/23.d845f6d8.js"><link rel="prefetch" href="/assets/js/230.2e0a02ff.js"><link rel="prefetch" href="/assets/js/231.3a77efd5.js"><link rel="prefetch" href="/assets/js/232.b5bbcb42.js"><link rel="prefetch" href="/assets/js/233.cc853042.js"><link rel="prefetch" href="/assets/js/234.757ff651.js"><link rel="prefetch" href="/assets/js/235.660cc45c.js"><link rel="prefetch" href="/assets/js/236.98ccd76a.js"><link rel="prefetch" href="/assets/js/237.b04def99.js"><link rel="prefetch" href="/assets/js/238.b4d318e6.js"><link rel="prefetch" href="/assets/js/239.449c536e.js"><link rel="prefetch" href="/assets/js/24.a1fa948d.js"><link rel="prefetch" href="/assets/js/240.57ff4221.js"><link rel="prefetch" href="/assets/js/241.1bd6a846.js"><link rel="prefetch" href="/assets/js/242.d95c91dc.js"><link rel="prefetch" href="/assets/js/243.1e6f8aac.js"><link rel="prefetch" href="/assets/js/244.2c4a8646.js"><link rel="prefetch" href="/assets/js/245.afaa20c3.js"><link rel="prefetch" href="/assets/js/246.16616268.js"><link rel="prefetch" href="/assets/js/247.3406b39c.js"><link rel="prefetch" href="/assets/js/248.165a9d74.js"><link rel="prefetch" href="/assets/js/249.1e4e5921.js"><link rel="prefetch" href="/assets/js/25.b335f886.js"><link rel="prefetch" href="/assets/js/250.0a4a23a1.js"><link rel="prefetch" href="/assets/js/251.6e59411b.js"><link rel="prefetch" href="/assets/js/252.f77513bf.js"><link rel="prefetch" href="/assets/js/253.dc28afed.js"><link rel="prefetch" href="/assets/js/255.6808c117.js"><link rel="prefetch" href="/assets/js/256.16f7d2c3.js"><link rel="prefetch" href="/assets/js/257.68e09d25.js"><link rel="prefetch" href="/assets/js/258.f03f1c22.js"><link rel="prefetch" href="/assets/js/259.62ed35af.js"><link rel="prefetch" href="/assets/js/26.0b12b1d4.js"><link rel="prefetch" href="/assets/js/260.ef39b24c.js"><link rel="prefetch" href="/assets/js/261.71e6f0db.js"><link rel="prefetch" href="/assets/js/262.bf234e8c.js"><link rel="prefetch" href="/assets/js/263.e3630155.js"><link rel="prefetch" href="/assets/js/264.04e2bcb8.js"><link rel="prefetch" href="/assets/js/265.6f4e18ce.js"><link rel="prefetch" href="/assets/js/266.aeb06326.js"><link rel="prefetch" href="/assets/js/27.bbed2698.js"><link rel="prefetch" href="/assets/js/28.b7b0808e.js"><link rel="prefetch" href="/assets/js/29.8643a805.js"><link rel="prefetch" href="/assets/js/3.ba802fc9.js"><link rel="prefetch" href="/assets/js/30.bb145cc6.js"><link rel="prefetch" href="/assets/js/31.b82c119c.js"><link rel="prefetch" href="/assets/js/32.3ebc8ac8.js"><link rel="prefetch" href="/assets/js/33.5a4570f6.js"><link rel="prefetch" href="/assets/js/34.a2c4b2ad.js"><link rel="prefetch" href="/assets/js/35.e424a17b.js"><link rel="prefetch" href="/assets/js/36.bcf7d6d3.js"><link rel="prefetch" href="/assets/js/37.87610ef6.js"><link rel="prefetch" href="/assets/js/38.63a687c1.js"><link rel="prefetch" href="/assets/js/39.6fe142e4.js"><link rel="prefetch" href="/assets/js/4.1e032f20.js"><link rel="prefetch" href="/assets/js/40.b931ff87.js"><link rel="prefetch" href="/assets/js/41.94fdb234.js"><link rel="prefetch" href="/assets/js/42.85378732.js"><link rel="prefetch" href="/assets/js/43.13a9295c.js"><link rel="prefetch" href="/assets/js/44.3228b04d.js"><link rel="prefetch" href="/assets/js/45.66a222b7.js"><link rel="prefetch" href="/assets/js/46.0c596ee2.js"><link rel="prefetch" href="/assets/js/47.50770cc8.js"><link rel="prefetch" href="/assets/js/48.56dce17d.js"><link rel="prefetch" href="/assets/js/49.a76a2cbb.js"><link rel="prefetch" href="/assets/js/5.68d5f562.js"><link rel="prefetch" href="/assets/js/50.11b83e09.js"><link rel="prefetch" href="/assets/js/51.b52ef253.js"><link rel="prefetch" href="/assets/js/52.032204ec.js"><link rel="prefetch" href="/assets/js/53.83cc7c06.js"><link rel="prefetch" href="/assets/js/54.0405a748.js"><link rel="prefetch" href="/assets/js/55.6b40fabe.js"><link rel="prefetch" href="/assets/js/56.6d6eeae4.js"><link rel="prefetch" href="/assets/js/57.27a5e368.js"><link rel="prefetch" href="/assets/js/58.7b7fc153.js"><link rel="prefetch" href="/assets/js/59.4fc050dd.js"><link rel="prefetch" href="/assets/js/6.628b9f9a.js"><link rel="prefetch" href="/assets/js/60.64dab6ba.js"><link rel="prefetch" href="/assets/js/61.fb115e71.js"><link rel="prefetch" href="/assets/js/62.19be661f.js"><link rel="prefetch" href="/assets/js/63.b50bec8c.js"><link rel="prefetch" href="/assets/js/64.4abe7d11.js"><link rel="prefetch" href="/assets/js/65.727de1b7.js"><link rel="prefetch" href="/assets/js/66.6500f2d0.js"><link rel="prefetch" href="/assets/js/67.4911332d.js"><link rel="prefetch" href="/assets/js/68.e7d2b80e.js"><link rel="prefetch" href="/assets/js/69.8b364c08.js"><link rel="prefetch" href="/assets/js/7.2381a9a5.js"><link rel="prefetch" href="/assets/js/70.bf129352.js"><link rel="prefetch" href="/assets/js/71.d62c85bf.js"><link rel="prefetch" href="/assets/js/72.685c7c67.js"><link rel="prefetch" href="/assets/js/73.bd9225b9.js"><link rel="prefetch" href="/assets/js/74.d0e63c75.js"><link rel="prefetch" href="/assets/js/75.ac1516c8.js"><link rel="prefetch" href="/assets/js/76.a76672e2.js"><link rel="prefetch" href="/assets/js/77.7fa90e9a.js"><link rel="prefetch" href="/assets/js/78.b27852cd.js"><link rel="prefetch" href="/assets/js/79.9964f1bb.js"><link rel="prefetch" href="/assets/js/8.a0f2028d.js"><link rel="prefetch" href="/assets/js/80.e831bc7f.js"><link rel="prefetch" href="/assets/js/81.f4adc35d.js"><link rel="prefetch" href="/assets/js/82.79dc5f2d.js"><link rel="prefetch" href="/assets/js/83.a42f5133.js"><link rel="prefetch" href="/assets/js/84.8c6c443a.js"><link rel="prefetch" href="/assets/js/85.c036fe47.js"><link rel="prefetch" href="/assets/js/86.253e8f74.js"><link rel="prefetch" href="/assets/js/87.4765a9dc.js"><link rel="prefetch" href="/assets/js/88.fd60117d.js"><link rel="prefetch" href="/assets/js/89.6a7b741f.js"><link rel="prefetch" href="/assets/js/9.18ef8d1c.js"><link rel="prefetch" href="/assets/js/90.5df03d9e.js"><link rel="prefetch" href="/assets/js/91.edc99526.js"><link rel="prefetch" href="/assets/js/92.a9aaf7f6.js"><link rel="prefetch" href="/assets/js/93.b5488e19.js"><link rel="prefetch" href="/assets/js/94.90c0b724.js"><link rel="prefetch" href="/assets/js/95.96685ca5.js"><link rel="prefetch" href="/assets/js/96.dfd1b877.js"><link rel="prefetch" href="/assets/js/97.4312b650.js"><link rel="prefetch" href="/assets/js/98.6b7e7ac0.js"><link rel="prefetch" href="/assets/js/99.c1f5db36.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.4cd972f0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6fddc57d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><!----> <span class="site-name">Vue Test Utils</span></a> <div class="links" style="max-width:nullpx;"><form id="search-form" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/api/" class="nav-link">API</a></div><div class="nav-item"><a href="/zh/guides/" class="nav-link router-link-exact-active router-link-active">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guides/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/ja/guides/" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/zh/guides/" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/ru/guides/" class="nav-link">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-test-utils" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/api/" class="nav-link">API</a></div><div class="nav-item"><a href="/zh/guides/" class="nav-link router-link-exact-active router-link-active">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guides/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/ja/guides/" class="nav-link">日本語</a></li><li class="dropdown-item"><!----> <a href="/zh/guides/" class="nav-link router-link-exact-active router-link-active">简体中文</a></li><li class="dropdown-item"><!----> <a href="/ru/guides/" class="nav-link">Русский</a></li></ul></div></div> <a href="https://github.com/vuejs/vue-test-utils" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div class="carbon-ads"></div> <ul class="sidebar-links"><li><a href="/zh/" class="sidebar-link">介绍</a></li><li><a href="/zh/guides/" class="active sidebar-link">教程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/guides/#起步" class="sidebar-link">起步</a></li><li class="sidebar-sub-header"><a href="/zh/guides/#常用技巧" class="sidebar-link">常用技巧</a></li><li class="sidebar-sub-header"><a href="/zh/guides/#测试键盘、鼠标等其它-dom-事件" class="sidebar-link">测试键盘、鼠标等其它 DOM 事件</a></li><li class="sidebar-sub-header"><a href="/zh/guides/#选择一个测试运行器" class="sidebar-link">选择一个测试运行器</a></li><li class="sidebar-sub-header"><a href="/zh/guides/#用-jest-测试单文件组件" class="sidebar-link">用 Jest 测试单文件组件</a></li><li class="sidebar-sub-header"><a href="/zh/guides/#用-mocha-和-webpack-测试单文件组件" class="sidebar-link">用 Mocha 和 webpack 测试单文件组件</a></li><li class="sidebar-sub-header"><a href="/zh/guides/#用-karma-测试单文件组件" class="sidebar-link">用 Karma 测试单文件组件</a></li><li class="sidebar-sub-header"><a href="/zh/guides/#测试异步行为" class="sidebar-link">测试异步行为</a></li><li class="sidebar-sub-header"><a href="/zh/guides/#配合-typescript-使用" class="sidebar-link">配合 TypeScript 使用</a></li><li class="sidebar-sub-header"><a href="/zh/guides/#配合-vue-router-使用" class="sidebar-link">配合 Vue Router 使用</a></li><li class="sidebar-sub-header"><a href="/zh/guides/#在组件中测试-vuex" class="sidebar-link">在组件中测试 Vuex</a></li></ul></li><li><a href="/zh/api/" class="sidebar-link">API</a></li><li><a href="/zh/api/wrapper/" class="sidebar-link">Wrapper</a></li><li><a href="/zh/api/wrapper-array/" class="sidebar-link">WrapperArray</a></li><li><a href="/zh/api/options.html" class="sidebar-link">挂载选项</a></li><li><a href="/zh/api/components/" class="sidebar-link">组件</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="教程"><a href="#教程" class="header-anchor">#</a> 教程</h1> <h2 id="起步"><a href="#起步" class="header-anchor">#</a> 起步</h2> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <p>快速尝鲜 Vue Test Utils 的办法就是克隆我们的 demo 仓库再加上基本的设置和依赖安装。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/vuejs/vue-test-utils-getting-started
<span class="token builtin class-name">cd</span> vue-test-utils-getting-started
<span class="token function">npm</span> <span class="token function">install</span>
</code></pre></div><p>你会发现该工程包含了一个简单的组件 <code>counter.js</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// counter.js</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  template<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div&gt;
      &lt;span class=&quot;count&quot;&gt;{{ count }}&lt;/span&gt;
      &lt;button @click=&quot;increment&quot;&gt;Increment&lt;/button&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>

  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      count<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="挂载组件"><a href="#挂载组件" class="header-anchor">#</a> 挂载组件</h3> <p>Vue Test Utils 通过将它们隔离挂载，然后模拟必要的输入 (prop、注入和用户事件) 和对输出 (渲染结果、触发的自定义事件) 的断言来测试 Vue 组件。</p> <p>被挂载的组件会返回到一个<a href="/zh/api/wrapper/">包裹器</a>内，而包裹器会暴露很多封装、遍历和查询其内部的 Vue 组件实例的便捷的方法。</p> <p>你可以通过 <code>mount</code> 方法来创建包裹器。让我们创建一个名叫 <code>test.js</code> 的文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>

<span class="token comment">// 从测试实用工具集中导入 `mount()` 方法</span>
<span class="token comment">// 同时导入你要测试的组件</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Counter <span class="token keyword">from</span> <span class="token string">'./counter'</span>

<span class="token comment">// 现在挂载组件，你便得到了这个包裹器</span>
<span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span>

<span class="token comment">// 你可以通过 `wrapper.vm` 访问实际的 Vue 实例</span>
<span class="token keyword">const</span> vm <span class="token operator">=</span> wrapper<span class="token punctuation">.</span>vm

<span class="token comment">// 在控制台将其记录下来即可深度审阅包裹器</span>
<span class="token comment">// 我们对 Vue Test Utils 的探索也由此开始</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span>
</code></pre></div><h3 id="测试组件渲染出来的-html"><a href="#测试组件渲染出来的-html" class="header-anchor">#</a> 测试组件渲染出来的 HTML</h3> <p>现在我们已经有了这个包裹器，我们能做的第一件事就是认证该组件渲染出来的 HTML 符合预期。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Counter <span class="token keyword">from</span> <span class="token string">'./counter'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Counter'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 现在挂载组件，你便得到了这个包裹器</span>
  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'renders the correct markup'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span><span class="token string">'&lt;span class=&quot;count&quot;&gt;0&lt;/span&gt;'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 也便于检查已存在的元素</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'has a button'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>现在运行 <code>npm test</code> 进行测试。你应该看得到测试通过。</p> <h3 id="模拟用户交互"><a href="#模拟用户交互" class="header-anchor">#</a> 模拟用户交互</h3> <p>当用户点击按钮的时候，我们的计数器应该递增。为了模拟这一行为，我们首先需要通过 <code>wrapper.find()</code> 定位该按钮，此方法返回一个<strong>该按钮元素的包裹器</strong>。然后我们能够通过对该按钮包裹器调用 <code>.trigger()</code> 来模拟点击。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'button click should increment the count'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> button <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span>
  button<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="关于-nexttick-怎么办？"><a href="#关于-nexttick-怎么办？" class="header-anchor">#</a> 关于 <code>nextTick</code> 怎么办？</h3> <p>Vue 会异步的将未生效的 DOM 更新批量应用，以避免因数据反复突变而导致的无谓的重渲染。这也是为什么在实践过程中我们经常在触发状态改变后用 <code>Vue.nextTick</code> 来等待 Vue 把实际的 DOM 更新做完的原因。</p> <p>为了简化用法，Vue Test Utils 同步应用了所有的更新，所以你不需要在测试中使用 <code>Vue.nextTick</code> 来等待 DOM 更新。</p> <p><em>注意：当你需要为诸如异步回调或 Promise 解析等操作显性改进为事件循环的时候，<code>nextTick</code> 仍然是必要的。</em></p> <p>如果你仍然需要在自己的测试文件中使用 <code>nextTick</code>，注意任何在其内部被抛出的错误可能都不会被测试运行器捕获，因为其内部使用了 Promise。关于这个问题有两个建议：要么你可以在测试的一开始将 Vue 的全局错误处理器设置为 <code>done</code> 回调，要么你可以在调用 <code>nextTick</code> 时不带参数让其作为一个 Promise 返回：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这不会被捕获</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'will time out'</span><span class="token punctuation">,</span> <span class="token parameter">done</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 接下来的两项测试都会如预期工作</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'will catch the error using done'</span><span class="token punctuation">,</span> <span class="token parameter">done</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>errorHandler <span class="token operator">=</span> done
  Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'will catch the error using a promise'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="下一步是什么"><a href="#下一步是什么" class="header-anchor">#</a> 下一步是什么</h3> <ul><li><a href="/zh/guides/choosing-a-test-runner.html">选择一个测试运行器</a>以把 Vue Test Utils 集成到你的工程里。</li> <li>移步<a href="/zh/guides/common-tips.html">撰写测试的常见技巧</a>以学习更多。</li></ul> <h2 id="常用技巧"><a href="#常用技巧" class="header-anchor">#</a> 常用技巧</h2> <h3 id="明白要测试的是什么"><a href="#明白要测试的是什么" class="header-anchor">#</a> 明白要测试的是什么</h3> <p>对于 UI 组件来说，我们不推荐一味追求行级覆盖率，因为它会导致我们过分关注组件的内部实现细节，从而导致琐碎的测试。</p> <p>取而代之的是，我们推荐把测试撰写为断言你的组件的公共接口，并在一个黑盒内部处理它。一个简单的测试用例将会断言一些输入 (用户的交互或 prop 的改变) 提供给某组件之后是否导致预期结果 (渲染结果或触发自定义事件)。</p> <p>比如，对于每次点击按钮都会将计数加一的 <code>Counter</code> 组件来说，其测试用例将会模拟点击并断言渲染结果会加 1。该测试并没有关注 <code>Counter</code> 如何递增数值，而只关注其输入和输出。</p> <p>该提议的好处在于，即便该组件的内部实现已经随时间发生了改变，只要你的组件的公共接口始终保持一致，测试就可以通过。</p> <p>这个话题的细节在 <a href="https://www.youtube.com/watch?v=OIpfWTThrK8" target="_blank" rel="noopener noreferrer">Matt O'Connell 一份非常棒的演讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中有更多的讨论。</p> <h3 id="浅渲染"><a href="#浅渲染" class="header-anchor">#</a> 浅渲染</h3> <p>在测试用例中，我们通常希望专注在一个孤立的单元中测试组件，避免对其子组件的行为进行间接的断言。</p> <p>额外的，对于包含许多子组件的组件来说，整个渲染树可能会非常大。重复渲染所有的子组件可能会让我们的测试变慢。</p> <p>Vue Test Utils 允许你通过 <code>shallowMount</code> 方法只挂载一个组件而不渲染其子组件 (即保留它们的存根)：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>

<span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span>
wrapper<span class="token punctuation">.</span>vm <span class="token comment">// 挂载的 Vue 实例</span>
</code></pre></div><h3 id="断言触发的事件"><a href="#断言触发的事件" class="header-anchor">#</a> 断言触发的事件</h3> <p>每个挂载的包裹器都会通过其背后的 Vue 实例自动记录所有被触发的事件。你可以用 <code>wrapper.emitted()</code> 方法取回这些事件记录。</p> <div class="language-js extra-class"><pre class="language-js"><code>wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span>

<span class="token comment">/*
`wrapper.emitted()` 返回以下对象：
{
  foo: [[], [123]]
}
*/</span>
</code></pre></div><p>然后你可以基于这些数据来设置断言：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 断言事件已经被触发</span>
<span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">emitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 断言事件的数量</span>
<span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">emitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foo<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment">// 断言事件的有效数据</span>
<span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">emitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foo<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>你也可以调用 <a href="/zh/api/wrapper/emittedByOrder.html"><code>wrapper.emittedByOrder()</code></a> 获取一个按触发先后排序的事件数组。</p> <h3 id="从子组件触发事件"><a href="#从子组件触发事件" class="header-anchor">#</a> 从子组件触发事件</h3> <p>你可以通过访问子组件实例来触发一个自定义事件</p> <p><strong>待测试的组件</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-component</span> <span class="token attr-name">@custom</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>onCustom<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>emitted<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Emitted!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> ChildComponent <span class="token keyword">from</span> <span class="token string">'./ChildComponent'</span>

  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'ParentComponent'</span><span class="token punctuation">,</span>
    components<span class="token punctuation">:</span> <span class="token punctuation">{</span> ChildComponent <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        emitted<span class="token punctuation">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">onCustom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>emitted <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>测试代码</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> ParentComponent <span class="token keyword">from</span> <span class="token string">'@/components/ParentComponent'</span>
<span class="token keyword">import</span> ChildComponent <span class="token keyword">from</span> <span class="token string">'@/components/ChildComponent'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'ParentComponent'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;displays 'Emitted!' when custom event is emitted&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>ParentComponent<span class="token punctuation">)</span>
    wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>ChildComponent<span class="token punctuation">)</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'custom'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span><span class="token string">'Emitted!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="操作组件状态"><a href="#操作组件状态" class="header-anchor">#</a> 操作组件状态</h3> <p>你可以在包裹器上用 <code>setData</code> 或 <code>setProps</code> 方法直接操作组件状态：</p> <div class="language-js extra-class"><pre class="language-js"><code>wrapper<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

wrapper<span class="token punctuation">.</span><span class="token function">setProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'bar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="仿造-prop"><a href="#仿造-prop" class="header-anchor">#</a> 仿造 Prop</h3> <p>你可以使用 Vue 在内置 <code>propsData</code> 选项向组件传入 prop：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>

<span class="token function">mount</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  propsData<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    aProp<span class="token punctuation">:</span> <span class="token string">'some value'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>你也可以用 <code>wrapper.setProps({})</code> 方法更新这些已经挂载的组件的 prop：</p> <p><em>想查阅所有选项的完整列表，请移步该文档的<a href="/zh/api/options.html">挂载选项</a>章节。</em></p> <h3 id="应用全局的插件和混入"><a href="#应用全局的插件和混入" class="header-anchor">#</a> 应用全局的插件和混入</h3> <p>有些组件可能依赖一个全局插件或混入 (mixin) 的功能注入，比如 <code>vuex</code> 和 <code>vue-router</code>。</p> <p>如果你在为一个特定的应用撰写组件，你可以在你的测试入口处一次性设置相同的全局插件和混入。但是有些情况下，比如测试一个可能会跨越不同应用共享的普通的组件套件的时候，最好还是在一个更加隔离的设置中测试你的组件，不对全局的 <code>Vue</code> 构造函数注入任何东西。我们可以使用 <a href="/zh/api/createLocalVue.html"><code>createLocalVue</code></a> 方法来存档它们：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createLocalVue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>

<span class="token comment">// 创建一个扩展的 `Vue` 构造函数</span>
<span class="token keyword">const</span> localVue <span class="token operator">=</span> <span class="token function">createLocalVue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 正常安装插件</span>
localVue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>MyPlugin<span class="token punctuation">)</span>

<span class="token comment">// 在挂载选项中传入 `localVue`</span>
<span class="token function">mount</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  localVue
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>注意有些插件会为全局的 Vue 构造函数添加只读属性，比如 Vue Router。这使得我们无法在一个 <code>localVue</code> 构造函数上二次安装该插件，或伪造这些只读属性。</strong></p> <h3 id="仿造注入"><a href="#仿造注入" class="header-anchor">#</a> 仿造注入</h3> <p>另一个注入 prop 的策略就是简单的仿造它们。你可以使用 <code>mocks</code> 选项：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>

<span class="token keyword">const</span> $route <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
  hash<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  params<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">'123'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  query<span class="token punctuation">:</span> <span class="token punctuation">{</span> q<span class="token punctuation">:</span> <span class="token string">'hello'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">mount</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  mocks<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在挂载组件之前</span>
    <span class="token comment">// 添加仿造的 `$route` 对象到 Vue 实例中</span>
    $route
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="存根组件"><a href="#存根组件" class="header-anchor">#</a> 存根组件</h3> <p>你可以使用 <code>stubs</code> 选项覆写全局或局部注册的组件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>

<span class="token function">mount</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将会把 globally-registered-component 解析为</span>
  <span class="token comment">// 空的存根</span>
  stubs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'globally-registered-component'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="处理路由"><a href="#处理路由" class="header-anchor">#</a> 处理路由</h3> <p>因为路由需要在应用的全局结构中进行定义，且引入了很多组件，所以最好集成到 end-to-end 测试。对于依赖 <code>vue-router</code> 功能的独立的组件来说，你可以使用上面提到的技术仿造它们。</p> <h3 id="探测样式"><a href="#探测样式" class="header-anchor">#</a> 探测样式</h3> <p>当你的测试运行在 <code>jsdom</code> 中时，只能探测到内联样式。</p> <h2 id="测试键盘、鼠标等其它-dom-事件"><a href="#测试键盘、鼠标等其它-dom-事件" class="header-anchor">#</a> 测试键盘、鼠标等其它 DOM 事件</h2> <h3 id="触发事件"><a href="#触发事件" class="header-anchor">#</a> 触发事件</h3> <p><code>Wrapper</code> 暴露了一个 <code>trigger</code> 方法。它可以用来触发 DOM 事件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>MyButton<span class="token punctuation">)</span>

wrapper<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
</code></pre></div><p>你应该注意到了，<code>find</code> 方法也会返回一个 <code>Wrapper</code>。假设 <code>MyComponent</code> 包含一个按钮，下面的代码会点击这个按钮。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>MyComponent<span class="token punctuation">)</span>

wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="选项"><a href="#选项" class="header-anchor">#</a> 选项</h3> <p>其 <code>trigger</code> 方法接受一个可选的 <code>options</code> 对象。这个 <code>options</code> 对象里的属性会被添加到事件中。</p> <p>注意其目标不能被添加到 <code>options</code> 对象中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>MyButton<span class="token punctuation">)</span>

wrapper<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> button<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="鼠标点击示例"><a href="#鼠标点击示例" class="header-anchor">#</a> 鼠标点击示例</h3> <p><strong>待测试的组件</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>yes<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>callYes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>no<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>callNo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>No<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'YesNoComponent'</span><span class="token punctuation">,</span>

    props<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      callMe<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> Function
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">callYes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callMe</span><span class="token punctuation">(</span><span class="token string">'yes'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">callNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callMe</span><span class="token punctuation">(</span><span class="token string">'no'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>测试</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> YesNoComponent <span class="token keyword">from</span> <span class="token string">'@/components/YesNoComponent'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> sinon <span class="token keyword">from</span> <span class="token string">'sinon'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Click event'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Click on yes button calls our method with argument &quot;yes&quot;'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> spy <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">spy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>YesNoComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      propsData<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        callMe<span class="token punctuation">:</span> spy
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button.yes'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>

    spy<span class="token punctuation">.</span>should<span class="token punctuation">.</span>have<span class="token punctuation">.</span>been<span class="token punctuation">.</span><span class="token function">calledWith</span><span class="token punctuation">(</span><span class="token string">'yes'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="键盘示例"><a href="#键盘示例" class="header-anchor">#</a> 键盘示例</h3> <p><strong>待测试的组件</strong></p> <p>这个组件允许使用不同的按键将数量递增/递减。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@keydown.prevent</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>onKeydown<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>quantity<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> <span class="token constant">KEY_DOWN</span> <span class="token operator">=</span> <span class="token number">40</span>
  <span class="token keyword">const</span> <span class="token constant">KEY_UP</span> <span class="token operator">=</span> <span class="token number">38</span>
  <span class="token keyword">const</span> <span class="token constant">ESCAPE</span> <span class="token operator">=</span> <span class="token number">27</span>

  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        quantity<span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>quantity <span class="token operator">+=</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>quantity <span class="token operator">-=</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>quantity <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">onKeydown</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>keyCode <span class="token operator">===</span> <span class="token constant">ESCAPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>keyCode <span class="token operator">===</span> <span class="token constant">KEY_DOWN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>keyCode <span class="token operator">===</span> <span class="token constant">KEY_UP</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>quantity <span class="token operator">=</span> <span class="token number">13</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">quantity</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>Test</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> QuantityComponent <span class="token keyword">from</span> <span class="token string">'@/components/QuantityComponent'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Key event tests'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Quantity is zero by default'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>QuantityComponent<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Up arrow key increments quantity by 1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>QuantityComponent<span class="token punctuation">)</span>
    wrapper<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'keydown.up'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Down arrow key decrements quantity by 1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>QuantityComponent<span class="token punctuation">)</span>
    wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>quantity <span class="token operator">=</span> <span class="token number">5</span>
    wrapper<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'keydown.down'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Escape sets quantity to 0'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>QuantityComponent<span class="token punctuation">)</span>
    wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>quantity <span class="token operator">=</span> <span class="token number">5</span>
    wrapper<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'keydown.esc'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Magic character &quot;a&quot; sets quantity to 13'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>QuantityComponent<span class="token punctuation">)</span>
    wrapper<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'keydown'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      key<span class="token punctuation">:</span> <span class="token string">'a'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>限制</strong></p> <p>点后面的按键名 <code>keydown.up</code> 会被翻译成一个 <code>keyCode</code>。这些被支持的按键名有：</p> <table><thead><tr><th>key name</th> <th>key code</th></tr></thead> <tbody><tr><td>enter</td> <td>13</td></tr> <tr><td>esc</td> <td>27</td></tr> <tr><td>tab</td> <td>9</td></tr> <tr><td>space</td> <td>32</td></tr> <tr><td>delete</td> <td>46</td></tr> <tr><td>backspace</td> <td>8</td></tr> <tr><td>insert</td> <td>45</td></tr> <tr><td>up</td> <td>38</td></tr> <tr><td>down</td> <td>40</td></tr> <tr><td>left</td> <td>37</td></tr> <tr><td>right</td> <td>39</td></tr> <tr><td>end</td> <td>35</td></tr> <tr><td>home</td> <td>36</td></tr> <tr><td>pageup</td> <td>33</td></tr> <tr><td>pagedown</td> <td>34</td></tr></tbody></table> <h3 id="重要事项"><a href="#重要事项" class="header-anchor">#</a> 重要事项</h3> <p>Vue Test Utils 是同步触发事件。因此 <code>Vue.nextTick</code> 不是必须的。</p> <h2 id="选择一个测试运行器"><a href="#选择一个测试运行器" class="header-anchor">#</a> 选择一个测试运行器</h2> <p>测试运行器 (test runner) 就是运行测试的程序。</p> <p>主流的 JavaScript 测试运行器有很多，但 Vue Test Utils 都能够支持。它是与测试运行器无关的。</p> <p>当然在我们选用测试运行器的时候也需要考虑一些事项：功能集合、性能和对单文件组件预编译的支持等。在仔细比对现有的库之后，我们推荐其中的两个测试运行器：</p> <ul><li><p><a href="https://jestjs.io/docs/zh-Hans/getting-started" target="_blank" rel="noopener noreferrer">Jest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是功能最全的测试运行器。它所需的配置是最少的，默认安装了 JSDOM，内置断言且命令行的用户体验非常好。不过你需要一个能够将单文件组件导入到测试中的预处理器。我们已经创建了 <code>vue-jest</code> 预处理器来处理最常见的单文件组件特性，但仍不是 <code>vue-loader</code> 100% 的功能。</p></li> <li><p><a href="https://github.com/zinserjan/mocha-webpack" target="_blank" rel="noopener noreferrer">mocha-webpack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个 webpack + Mocha 的包裹器，同时包含了更顺畅的接口和侦听模式。这些设置的好处在于我们能够通过 webpack + <code>vue-loader</code> 得到完整的单文件组件支持，但这本身是需要很多配置的。</p></li></ul> <h3 id="浏览器环境"><a href="#浏览器环境" class="header-anchor">#</a> 浏览器环境</h3> <p>Vue Test Utils 依赖浏览器环境。技术上讲你可以将其运行在一个真实的浏览器，但是我们并不推荐，因为在不同的平台上都启动真实的浏览器是很复杂的。我们推荐取而代之的是用 <a href="https://github.com/tmpvar/jsdom" target="_blank" rel="noopener noreferrer">JSDOM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 在 Node 虚拟浏览器环境运行测试。</p> <p>Jest 测试运行器自动设置了 JSDOM。对于其它测试运行器来说，你可以在你的测试入口处使用 <a href="https://github.com/rstacruz/jsdom-global" target="_blank" rel="noopener noreferrer">jsdom-global<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 手动设置 JSDOM。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev jsdom jsdom-global
</code></pre></div><hr> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 在测试的设置 / 入口中</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsdom-global'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="测试单文件组件"><a href="#测试单文件组件" class="header-anchor">#</a> 测试单文件组件</h3> <p>Vue 的单文件组件在它们运行于 Node 或浏览器之前是需要预编译的。我们推荐两种方式完成编译：通过一个 Jest 预编译器，或直接使用 webpack。</p> <p><code>vue-jest</code> 预处理器支持基本的单文件组件功能，但是目前还不能处理样式块和自定义块，这些都只在 <code>vue-loader</code> 中支持。如果你依赖这些功能或其它 webpack 特有的配置项，那么你需要基于 webpack + <code>vue-loader</code> 进行设置。</p> <p>对于不同的设置方式请移步下面的教程：</p> <ul><li><a href="/zh/guides/testing-single-file-components-with-jest.html">用 Jest 测试单文件组件</a></li> <li><a href="/zh/guides/testing-single-file-components-with-mocha-webpack.html">用 Mocha 和 webpack 测试单文件组件</a></li></ul> <h3 id="相关资料"><a href="#相关资料" class="header-anchor">#</a> 相关资料</h3> <ul><li><a href="https://github.com/eddyerburgh/vue-unit-test-perf-comparison" target="_blank" rel="noopener noreferrer">测试运行器性能比拼<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/vuejs/vue-test-utils-jest-example" target="_blank" rel="noopener noreferrer">使用 Jest 的示例工程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/vuejs/vue-test-utils-mocha-webpack-example" target="_blank" rel="noopener noreferrer">使用 Mocha 的示例工程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/eddyerburgh/vue-test-utils-tape-example" target="_blank" rel="noopener noreferrer">使用 tape 的示例工程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/eddyerburgh/vue-test-utils-ava-example" target="_blank" rel="noopener noreferrer">使用 AVA 的示例工程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/egoist/tyu" target="_blank" rel="noopener noreferrer">tyu - Delightful web testing by egoist<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="用-jest-测试单文件组件"><a href="#用-jest-测试单文件组件" class="header-anchor">#</a> 用 Jest 测试单文件组件</h2> <blockquote><p>我们在 <a href="https://github.com/vuejs/vue-test-utils-jest-example" target="_blank" rel="noopener noreferrer">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 上放有一个关于这些设置的示例工程。</p></blockquote> <p>Jest 是一个由 Facebook 开发的测试运行器，致力于提供一个“bettery-included”单元测试解决方案。你可以在其<a href="https://jestjs.io/" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>学习到更多 Jest 的知识。</p> <h3 id="安装-jest"><a href="#安装-jest" class="header-anchor">#</a> 安装 Jest</h3> <p>我们假定你在一开始已经安装并配置好了 webpack、vue-loader 和 Babel——例如通过 <code>vue-cli</code> 创建了 <code>webpack-simple</code> 模板脚手架。</p> <p>我们要做的第一件事就是安装 Jest 和 Vue Test Utils：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev jest @vue/test-utils
</code></pre></div><p>然后我们需要在 <code>package.json</code> 中定义一个单元测试的脚本。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="在-jest-中处理单文件组件"><a href="#在-jest-中处理单文件组件" class="header-anchor">#</a> 在 Jest 中处理单文件组件</h3> <p>为了告诉 Jest 如何处理 <code>*.vue</code> 文件，我们需要安装和配置 <code>vue-jest</code> 预处理器：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev vue-jest
</code></pre></div><p>接下来在 <code>package.json</code> 中创建一个 <code>jest</code> 块：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;moduleFileExtensions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;js&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span>
      <span class="token comment">// 告诉 Jest 处理 `*.vue` 文件</span>
      <span class="token string">&quot;vue&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;transform&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 用 `vue-jest` 处理 `*.vue` 文件</span>
      <span class="token property">&quot;.*\\.(vue)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-jest&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><strong>注意：</strong><code>vue-jest</code> 目前并不支持 <code>vue-loader</code> 所有的功能，比如自定义块和样式加载。额外的，诸如代码分隔等 webpack 特有的功能也是不支持的。如果要使用这些不支持的特性，你需要用 Mocha 取代 Jest 来运行你的测试，同时用 webpack 来编译你的组件。想知道如何起步，请阅读教程里的<a href="/zh/guides/testing-single-file-components-with-mocha-webpack.html">用 Mocha + webpack 测试单文件组件</a>。</p></blockquote> <h3 id="处理-webpack-别名"><a href="#处理-webpack-别名" class="header-anchor">#</a> 处理 webpack 别名</h3> <p>如果你在 webpack 中配置了别名解析，比如把 <code>@</code> 设置为 <code>/src</code> 的别名，那么你也需要用 <code>moduleNameMapper</code> 选项为 Jest 增加一个匹配配置：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 支持源代码中相同的 `@` -&gt; `src` 别名</span>
    <span class="token property">&quot;moduleNameMapper&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;^@/(.*)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/src/$1&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="为-jest-配置-babel"><a href="#为-jest-配置-babel" class="header-anchor">#</a> 为 Jest 配置 Babel</h3> <p>尽管最新版本的 Node 已经支持绝大多数的 ES2015 特性，你可能仍然想要在你的测试中使用 ES modules 语法和 stage-x 的特性。为此我们需要安装 <code>babel-jest</code>：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev babel-jest
</code></pre></div><p>接下来，我们需要在 <code>package.json</code> 的 <code>jest.transform</code> 里添加一个入口，来告诉 Jest 用 <code>babel-jest</code> 处理 JavaScript 测试文件：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token property">&quot;transform&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// 用 `babel-jest` 处理 js</span>
      <span class="token property">&quot;^.+\\.js$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/node_modules/babel-jest&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>默认情况下，<code>babel-jest</code> 会在其安装完毕后自动进行配置。尽管如此，因为我们已经显性的添加了对 <code>*.vue</code> 文件的转换，所以现在我们也需要显性的配置 <code>babel-jest</code>。</p></blockquote> <p>我们假设 webpack 使用了 <code>babel-preset-env</code>，这时默认的 Babel 配置会关闭 ES modules 的转译，因为 webpack 已经可以处理 ES modules 了。然而，我们还是需要为我们的测试而开启它，因为 Jest 的测试用例会直接运行在 Node 上。</p> <p>同样的，我们可以告诉 <code>babel-preset-env</code> 面向我们使用的 Node 版本。这样做会跳过转译不必要的特性使得测试启动更快。</p> <p>为了仅在测试时应用这些选项，可以把它们放到一个独立的 <code>env.test</code> 配置项中 (这会被 <code>babel-jest</code> 自动获取)。</p> <p><code>.babelrc</code> 文件示例：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;targets&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;node&quot;</span><span class="token operator">:</span> <span class="token string">&quot;current&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="放置测试文件"><a href="#放置测试文件" class="header-anchor">#</a> 放置测试文件</h3> <p>默认情况下，Jest 将会递归的找到整个工程里所有 <code>.spec.js</code> 或 <code>.test.js</code> 扩展名的文件。如果这不符合你的需求，你也可以在 <code>package.json</code> 里的配置段落中<a href="https://jestjs.io/docs/zh-Hans/configuration#testregex-string-array-string" target="_blank" rel="noopener noreferrer">改变它的 <code>testRegex</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>Jest 推荐你在被测试代码的所在目录下创建一个 <code>__tests__</code> 目录，但你也可以为你的测试文件随意设计自己习惯的文件结构。不过要当心 Jest 会为快照测试在临近测试文件的地方创建一个 <code>__snapshots__</code> 目录。</p> <h3 id="测试覆盖率"><a href="#测试覆盖率" class="header-anchor">#</a> 测试覆盖率</h3> <p>Jest 可以被用来生成多种格式的测试覆盖率报告。以下是一个简单的起步的例子：</p> <p>扩展你的 <code>jest</code> 配置 (通常在 <code>package.json</code> 或 <code>jest.config.js</code> 中) 的 <a href="https://jestjs.io/docs/zh-Hans/configuration#collectcoverage-boolean" target="_blank" rel="noopener noreferrer"><code>collectCoverage</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 选项，然后添加 <a href="https://jestjs.io/docs/zh-Hans/configuration#collectcoveragefrom-array" target="_blank" rel="noopener noreferrer"><code>collectCoverageFrom</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 数组来定义需要收集测试覆盖率信息的文件。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token property">&quot;collectCoverage&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;collectCoverageFrom&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;**/*.{js,vue}&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;!**/node_modules/**&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样就会开启<a href="https://jestjs.io/docs/zh-Hans/configuration#coveragereporters-array-string" target="_blank" rel="noopener noreferrer">默认格式的测试覆盖率报告<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。你可以通过 <code>coverageReporters</code> 选项来定制它们。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token property">&quot;coverageReporters&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;html&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text-summary&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更多文档内容请移步至 <a href="https://jestjs.io/docs/zh-Hans/configuration#collectcoverage-boolean" target="_blank" rel="noopener noreferrer">Jest 配置文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，在那里你可以找到覆盖率阀值、目标输出目录等选项。</p> <h3 id="测试规范示例"><a href="#测试规范示例" class="header-anchor">#</a> 测试规范示例</h3> <p>如果你已经熟悉了 Jasmine，你应该很适应 Jest 的<a href="https://jestjs.io/docs/zh-Hans/expect" target="_blank" rel="noopener noreferrer">断言 API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Component <span class="token keyword">from</span> <span class="token string">'./component'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Component'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'is a Vue instance'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">isVueInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="快照测试"><a href="#快照测试" class="header-anchor">#</a> 快照测试</h3> <p>当你用 Vue Test Utils 挂载一个组件时，你可以访问到 HTML 根元素。这可以保存为一个快照为 <a href="https://jestjs.io/docs/zh-Hans/snapshot-testing" target="_blank" rel="noopener noreferrer">Jest 快照测试<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>所用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'renders correctly'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">mount</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>我们可以通过一个自定义的序列化工具改进被保存的快照：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev jest-serializer-vue
</code></pre></div><p>然后在 <code>package.json</code> 中配置它：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 快照的序列化工具</span>
    <span class="token property">&quot;snapshotSerializers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;jest-serializer-vue&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="相关资料-2"><a href="#相关资料-2" class="header-anchor">#</a> 相关资料</h3> <ul><li><a href="https://github.com/vuejs/vue-test-utils-jest-example" target="_blank" rel="noopener noreferrer">该设置的示例工程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/codebryo/vue-testing-with-jest-conf17" target="_blank" rel="noopener noreferrer">Vue Conf 2017 中的示例和幻灯片<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://jestjs.io/" target="_blank" rel="noopener noreferrer">Jest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/babel/babel-preset-env" target="_blank" rel="noopener noreferrer">Babel preset env<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="用-mocha-和-webpack-测试单文件组件"><a href="#用-mocha-和-webpack-测试单文件组件" class="header-anchor">#</a> 用 Mocha 和 webpack 测试单文件组件</h2> <blockquote><p>我们在 <a href="https://github.com/vuejs/vue-test-utils-mocha-webpack-example" target="_blank" rel="noopener noreferrer">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 上放有一个关于这些设置的示例工程。</p></blockquote> <p>另一个测试单文件组件的策略是通过 webpack 编译所有的测试文件然后在测试运行器中运行。这样做的好处是可以完全支持所有 webpack 和 <code>vue-loader</code> 的功能，所以我们不必对我们的源代码做任何妥协。</p> <p>从技术的角度讲，你可以使用任何喜欢的测试运行器并把所有的东西都手动串联起来，但是我们已经找到了 <a href="https://github.com/zinserjan/mocha-webpack" target="_blank" rel="noopener noreferrer"><code>mocha-webpack</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 能够为这项特殊任务提供非常流畅的体验。</p> <h3 id="设置-mocha-webpack"><a href="#设置-mocha-webpack" class="header-anchor">#</a> 设置 <code>mocha-webpack</code></h3> <p>我们假定你在一开始已经安装并配置好了 webpack、vue-loader 和 Babel——例如通过 <code>vue-cli</code> 创建了 <code>webpack-simple</code> 模板脚手架。</p> <p>首先要做的是安装测试依赖：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev @vue/test-utils mocha mocha-webpack
</code></pre></div><p>接下来我们需要在 <code>package.json</code> 中定义一个测试脚本。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mocha-webpack --webpack-config webpack.config.js --require test/setup.js test/**/*.spec.js&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里有一些注意事项：</p> <ul><li><p><code>--webpack-config</code> 标识指定了该测试使用的 webpack 配置文件。在大多数情况下该配置会在其实际项目的配置文件基础上做一些小的调整。我们晚些时候会再聊到这一点。</p></li> <li><p><code>--require</code> 标识确保了文件 <code>test/setup.js</code> 会在任何测试之前运行，这样我们可以在该文件中设置测试所需的全局环境。</p></li> <li><p>最后一个参数是该测试包所涵盖的所有测试文件的聚合。</p></li></ul> <h3 id="提取-webpack-配置"><a href="#提取-webpack-配置" class="header-anchor">#</a> 提取 webpack 配置</h3> <h4 id="暴露-npm-依赖"><a href="#暴露-npm-依赖" class="header-anchor">#</a> 暴露 NPM 依赖</h4> <p>在测试中我们很可能会导入一些 NPM 依赖——这里面的有些模块可能没有针对浏览器的场景编写，也不适合被 webpack 打包。另一个考虑是为了尽可能的将依赖外置以提升测试的启动速度。我们可以通过 <code>webpack-node-externals</code> 外置所有的 NPM 依赖：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> nodeExternals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-node-externals'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  externals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">nodeExternals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="源码表"><a href="#源码表" class="header-anchor">#</a> 源码表</h4> <p>源码表在 <code>mocha-webpack</code> 中需要通过内联的方式获取。推荐配置为：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  devtool<span class="token punctuation">:</span> <span class="token string">'inline-cheap-module-source-map'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果是在 IDE 中调试，我们推荐添加以下配置：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 在源码表中使用绝对路径 (对于在 IDE 中调试时很重要)</span>
    devtoolModuleFilenameTemplate<span class="token punctuation">:</span> <span class="token string">'[absolute-resource-path]'</span><span class="token punctuation">,</span>
    devtoolFallbackModuleFilenameTemplate<span class="token punctuation">:</span> <span class="token string">'[absolute-resource-path]?[hash]'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="设置浏览器环境"><a href="#设置浏览器环境" class="header-anchor">#</a> 设置浏览器环境</h3> <p>Vue Test Utils 需要在浏览器环境中运行。我们可以在 Node 中使用 <code>jsdom-global</code> 进行模拟：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev jsdom jsdom-global
</code></pre></div><p>然后在 <code>test/setup.js</code> 中写入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsdom-global'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>这行代码会在 Node 中添加一个浏览器环境，这样 Vue Test Utils 就可以正确运行了。</p> <h3 id="选用一个断言库"><a href="#选用一个断言库" class="header-anchor">#</a> 选用一个断言库</h3> <p><a href="http://chaijs.com/" target="_blank" rel="noopener noreferrer">Chai<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个流行的断言库，经常和 Mocha 配合使用。你可能也想把 <a href="http://sinonjs.org/" target="_blank" rel="noopener noreferrer">Sinon<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 用于创建间谍和存根。</p> <p>另外你也可以使用 <code>expect</code>，它现在是 Jest 的一部分，且在 Jest 文档里暴露了<a href="https://jestjs.io/docs/zh-Hans/expect" target="_blank" rel="noopener noreferrer">完全相同的 API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>这里我们将使用 <code>expect</code> 且令其全局可用，这样我们就不需要在每个测试文件里导入它了：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev <span class="token function">expect</span>
</code></pre></div><p>然后在 <code>test/setup.js</code> 中编写：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsdom-global'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

global<span class="token punctuation">.</span>expect <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'expect'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="为测试优化-babel"><a href="#为测试优化-babel" class="header-anchor">#</a> 为测试优化 Babel</h3> <p>注意我们使用了 <code>babel-loader</code> 来处理 JavaScript。如果你在你的应用中通过 <code>.babelrc</code> 文件使用了 Babel，那么你就已经算是把它配置好了。这里 <code>babel-loader</code> 将会自动使用相同的配置文件。</p> <p>有一件事值得注意，如果你使用了 Node 6+，它已经支持了主要的 ES2015 特性，那么你可以配置一个独立的 Babel <a href="https://babeljs.io/docs/usage/babelrc/#env-option" target="_blank" rel="noopener noreferrer">环境选项<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，只转译该 Node 版本中不支持的特性 (比如 <code>stage-2</code> 或 flow 语法支持等)。</p> <h3 id="添加一个测试"><a href="#添加一个测试" class="header-anchor">#</a> 添加一个测试</h3> <p>在 <code>src</code> 目录中创建一个名为 <code>Counter.vue</code> 的文件：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    {{ count }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>increment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>自增<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        count<span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后创建一个名为 <code>test/Counter.spec.js</code> 的测试文件并写入如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Counter <span class="token keyword">from</span> <span class="token string">'../src/Counter.vue'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Counter.vue'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'increments count when button is clicked'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span>
    wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatch</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>现在我们运行测试：</p> <div class="language- extra-class"><pre class="language-text"><code>npm run test
</code></pre></div><p>喔，我们的测试运行起来了！</p> <h3 id="测试覆盖率-2"><a href="#测试覆盖率-2" class="header-anchor">#</a> 测试覆盖率</h3> <p>如果想设置 <code>mocha-webpack</code> 的测试覆盖率，请参照 <a href="https://github.com/zinserjan/mocha-webpack/blob/master/docs/guides/code-coverage.md" target="_blank" rel="noopener noreferrer"><code>mocha-webpack</code> 测试覆盖率指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="相关资料-3"><a href="#相关资料-3" class="header-anchor">#</a> 相关资料</h3> <ul><li><a href="https://github.com/vuejs/vue-test-utils-mocha-webpack-example" target="_blank" rel="noopener noreferrer">该设置的示例工程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://mochajs.org/" target="_blank" rel="noopener noreferrer">Mocha<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://zinserjan.github.io/mocha-webpack/" target="_blank" rel="noopener noreferrer">mocha-webpack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://chaijs.com/" target="_blank" rel="noopener noreferrer">Chai<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://sinonjs.org/" target="_blank" rel="noopener noreferrer">Sinon<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://jestjs.io/docs/zh-Hans/expect" target="_blank" rel="noopener noreferrer">jest/expect<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="用-karma-测试单文件组件"><a href="#用-karma-测试单文件组件" class="header-anchor">#</a> 用 Karma 测试单文件组件</h2> <blockquote><p>我们在 <a href="https://github.com/eddyerburgh/vue-test-utils-karma-example" target="_blank" rel="noopener noreferrer">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 上放有一个该设置的示例工程。</p></blockquote> <p>Karma 是一个启动浏览器运行测试并生成报告的测试运行器。我们会使用 Mocha 框架撰写测试，同时使用 chai 作为断言库。</p> <h3 id="设置-mocha"><a href="#设置-mocha" class="header-anchor">#</a> 设置 Mocha</h3> <p>我们会假设你一开始已经正确配置好了 webpack、vue-loader 和 Babel——例如通过 <code>vue-cli</code> 的 <code>webpack-simple</code> 模板搭建起来。</p> <p>第一件要做的事是安装测试依赖：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev @vue/test-utils karma karma-chrome-launcher karma-mocha karma-sourcemap-loader karma-spec-reporter karma-webpack mocha
</code></pre></div><p>接下来我们需要在 <code>package.json</code> 定义一个测试脚本。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;karma start --single-run&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>--single-run</code> 标识告诉了 Karma 一次性运行该测试套件。</li></ul> <h3 id="karma-配置"><a href="#karma-配置" class="header-anchor">#</a> Karma 配置</h3> <p>在项目的主目录创建一个 <code>karma.conf.js</code> 文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// karma.conf.js</span>

<span class="token keyword">var</span> webpackConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config.js'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    frameworks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'mocha'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'test/**/*.spec.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    preprocessors<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">'**/*.spec.js'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'webpack'</span><span class="token punctuation">,</span> <span class="token string">'sourcemap'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    webpack<span class="token punctuation">:</span> webpackConfig<span class="token punctuation">,</span>

    reporters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'spec'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    browsers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Chrome'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个文件用来配置 Karma。</p> <p>我们需要用 webpack 预处理文件。为此，我们将 webpack 添加为预处理器，并引入我们的 webpack 配置。我们可以在项目基础中使用该 webpack 配置文件而无需任何修改。</p> <p>在我们的配置中，我们在 Chrome 中运行测试。如果想添加其它浏览器，可查阅<a href="http://karma-runner.github.io/3.0/config/browsers.html" target="_blank" rel="noopener noreferrer">Karma 文档的浏览器章节<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="选用一个断言库-2"><a href="#选用一个断言库-2" class="header-anchor">#</a> 选用一个断言库</h3> <p><a href="http://chaijs.com/" target="_blank" rel="noopener noreferrer">Chai<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个流行的常配合 Mocha 使用的断言库。你也可以选用 <a href="http://sinonjs.org/" target="_blank" rel="noopener noreferrer">Sinon<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来创建监视和存根。</p> <p>我们可以安装 <code>karma-chai</code> 插件以在我们的测试中使用 <code>chai</code>。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev karma-chai
</code></pre></div><h3 id="添加一个测试-2"><a href="#添加一个测试-2" class="header-anchor">#</a> 添加一个测试</h3> <p>在 <code>src</code> 中创建一个名为 <code>Counter.vue</code> 的文件：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    {{ count }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>increment<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Increment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        count<span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后添加一个名为 <code>test/Counter.spec.js</code> 的测试文件，并写入如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> expect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'chai'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Counter <span class="token keyword">from</span> <span class="token string">'../src/Counter.vue'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Counter.vue'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'increments count when button is clicked'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span>
    wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>接下来我们可以运行测试：</p> <div class="language- extra-class"><pre class="language-text"><code>npm run test
</code></pre></div><p>Woohoo，我们的测试跑起来了！</p> <h3 id="覆盖率"><a href="#覆盖率" class="header-anchor">#</a> 覆盖率</h3> <p>我们可以使用 <code>karma-coverage</code> 插件来设置 Karma 的代码覆盖率。</p> <p>默认情况下，<code>karma-coverage</code> 不会使用 source map 来对照覆盖率报告。所以我们需要使用 <code>babel-plugin-istanbul</code> 来确认正确匹配的覆盖率。</p> <p>安装 <code>karma-coverage</code>、<code>babel-plugin-istanbul</code> 和 <code>cross-env</code>：</p> <div class="language- extra-class"><pre class="language-text"><code>npm install --save-dev karma-coverage cross-env
</code></pre></div><p>我们会使用 <code>cross-env</code> 来设置一个 <code>BABEL_ENV</code> 环境变量。这样我们就可以在编译测试的时候使用 <code>babel-plugin-istanbul</code>——因为我们不想在生产环境下引入 <code>babel-plugin-istanbul</code>：</p> <div class="language- extra-class"><pre class="language-text"><code>npm install --save-dev babel-plugin-istanbul
</code></pre></div><p>更新你的 <code>.babelrc</code> 文件，在因测试设置了 <code>BABEL_ENV</code> 时使用 <code>babel-plugin-istanbul</code>：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;stage-3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;istanbul&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在更新 <code>karma.conf.js</code> 文件来进行覆盖率测试。添加 <code>coverage</code> 到 <code>reporters</code> 数组，并添加一个 <code>coverageReporter</code> 字段：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// karma.conf.js</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    reporters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'spec'</span><span class="token punctuation">,</span> <span class="token string">'coverage'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    coverageReporter<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      dir<span class="token punctuation">:</span> <span class="token string">'./coverage'</span><span class="token punctuation">,</span>
      reporters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'lcov'</span><span class="token punctuation">,</span> subdir<span class="token punctuation">:</span> <span class="token string">'.'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'text-summary'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后更新 <code>test</code> 脚本来设置 <code>BABEL_ENV</code>：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env BABEL_ENV=test karma start --single-run&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="相关资料-4"><a href="#相关资料-4" class="header-anchor">#</a> 相关资料</h3> <ul><li><a href="https://github.com/eddyerburgh/vue-test-utils-karma-example" target="_blank" rel="noopener noreferrer">该设置的示例工程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://karma-runner.github.io/" target="_blank" rel="noopener noreferrer">Karma<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://mochajs.org/" target="_blank" rel="noopener noreferrer">Mocha<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://chaijs.com/" target="_blank" rel="noopener noreferrer">Chai<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://sinonjs.org/" target="_blank" rel="noopener noreferrer">Sinon<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="测试异步行为"><a href="#测试异步行为" class="header-anchor">#</a> 测试异步行为</h2> <p>为了让测试变得简单，<code>@vue/test-utils</code> <em>同步</em>应用 DOM 更新。不过当测试一个带有回调或 Promise 等异步行为的组件时，你需要留意一些技巧。</p> <p>API 调用和 Vuex action 都是最常见的异步行为之一。下列例子展示了如何测试一个会调用到 API 的方法。这个例子使用 Jest 运行测试用例同时模拟了 HTTP 库 <code>axios</code>。更多关于 Jest 的手动模拟的介绍可移步<a href="https://jestjs.io/docs/zh-Hans/manual-mocks" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p><code>axios</code> 的模拟实现大概是这个样子的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token string">'value'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面的组件在按钮被点击的时候会调用一个 API，然后将响应的值赋给 <code>value</code>。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>fetchResults<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>

  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">async</span> <span class="token function">fetchResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'mock/service'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> response<span class="token punctuation">.</span>data
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>测试用例可以写成像这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Foo <span class="token keyword">from</span> <span class="token string">'./Foo'</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'fetches async when a button is clicked'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Foo<span class="token punctuation">)</span>
  wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>现在这则测试用例会失败，因为断言在 <code>fetchResults</code> 中的 Promise 完成之前就被调用了。大多数单元测试库都提供一个回调来使得运行期知道测试用例的完成时机。Jest 和 Mocha 都是用了 <code>done</code>。我们可以和 <code>$nextTick</code> 或 <code>setTimeout</code> 结合使用 <code>done</code> 来确保任何 Promise 都会在断言之前完成。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'fetches async when a button is clicked'</span><span class="token punctuation">,</span> <span class="token parameter">done</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Foo<span class="token punctuation">)</span>
  wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
  wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>setTimeout</code> 允许测试通过的原因是 Promise 回调的 microtask 队列会在处理 <code>setTimeout</code> 的回调的任务队列之前先被处理。也就是说在 <code>setTimeout</code> 的回调运行的时候，任何 microtask 队列上的 Promise 回调都已经执行过了。另一方面 <code>$nextTick</code> 会安排一个 microtask，但是因为 microtask 队列的处理方式是先进先出，所以也会保证回调在作出断言时已经被执行。更多的解释请移步<a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>另一个解决方案是使用一个 <code>async</code> 函数配合 npm 包 <code>flush-promises</code>。<code>flush-promises</code> 会清除所有等待完成的 Promise 具柄。你可以 <code>await</code> 该 <code>flushPromises</code> 调用，以此清除等待中的 Promise 并改进你的测试用例的可读性。</p> <p>更新后的测试看起来像这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> flushPromises <span class="token keyword">from</span> <span class="token string">'flush-promises'</span>
<span class="token keyword">import</span> Foo <span class="token keyword">from</span> <span class="token string">'./Foo'</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'fetches async when a button is clicked'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Foo<span class="token punctuation">)</span>
  wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">flushPromises</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>相同的技巧可以被运用在同样默认返回一个 Promise 的 Vuex action 中。</p> <h2 id="配合-typescript-使用"><a href="#配合-typescript-使用" class="header-anchor">#</a> 配合 TypeScript 使用</h2> <blockquote><p>我们在 <a href="https://github.com/vuejs/vue-test-utils-typescript-example" target="_blank" rel="noopener noreferrer">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 上放有一个关于这些设置的示例工程。</p></blockquote> <p>TypeScript 是一个流行的 JavaScript 超集，它在普通 JS 的基础上加入了类型 (type) 和类 (class)。Vue Test Utils 在发行包中包含了类型信息，因此它可以很好的和 TypeScript 配合使用。</p> <p>在这份指南中，我们会介绍如何基于 Vue CLI 的 TypeScript 设置，使用 Jest 和 Vue Test Utils 为一个 TypeScript 工程建立测试。</p> <h3 id="加入-typescript"><a href="#加入-typescript" class="header-anchor">#</a> 加入 TypeScript</h3> <p>首先，你需要创建一个工程。如果你还没有安装 Vue CLI 的话，请先全局安装：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">npm</span> <span class="token function">install</span> -g @vue/cli
</code></pre></div><p>然后通过下列命令创建一个工程：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ vue create hello-world
</code></pre></div><p>在 CLI 提示符中，选择 <code>Manually select features</code> (手动选择特性)，并选中 TypeScript 回车。这将会创建一个配置好 TypeScript 的工程。</p> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>如果你想要了解更多用 TypeScript 设置 Vue 的细节，请移步 <a href="https://github.com/Microsoft/TypeScript-Vue-Starter" target="_blank" rel="noopener noreferrer">TypeScript Vue starter guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></div> <p>下一步就是把 Jest 添加到工程中。</p> <h3 id="设置-jest"><a href="#设置-jest" class="header-anchor">#</a> 设置 Jest</h3> <p>Jest 是一个由 Facebook 研发的测试运行器，它致力于提供一个低能耗的测试解决方案。你可以在其<a href="https://jestjs.io/" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中了解更多 Jest 的情况。</p> <p>安装 Jest 和 Vue Test Utils：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev jest @vue/test-utils
</code></pre></div><p>接下来在 <code>package.json</code> 里定义一个 <code>test:unit</code> 脚本。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ..</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
    <span class="token property">&quot;test:unit&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest&quot;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ..</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="在-jest-中执行单文件组件"><a href="#在-jest-中执行单文件组件" class="header-anchor">#</a> 在 Jest 中执行单文件组件</h3> <p>为了讲解 Jest 如何处理 <code>*.vue</code> 文件，我们需要安装并配置 <code>vue-jest</code> 预处理器：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev vue-jest
</code></pre></div><p>然后在 <code>package.json</code> 里创建一个 <code>jest</code> 块：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;moduleFileExtensions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;js&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;ts&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span>
      <span class="token comment">// 告诉 Jest 处理 `*.vue` 文件</span>
      <span class="token string">&quot;vue&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;transform&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 用 `vue-jest` 处理 `*.vue` 文件</span>
      <span class="token property">&quot;.*\\.(vue)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-jest&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;testURL&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost/&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="为-jest-配置-typescript"><a href="#为-jest-配置-typescript" class="header-anchor">#</a> 为 Jest 配置 TypeScript</h3> <p>为了在测试中使用 TypeScript 文件，我们需要在 Jest 中设置编译 TypeScript。为此我们需要安装 <code>ts-jest</code>：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev ts-jest
</code></pre></div><p>接下来，我们需要在 <code>package.json</code> 中的 <code>jest.transform</code> 中加入一个入口告诉 Jest 使用 <code>ts-jest</code> 处理 TypeScript 测试文件：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token property">&quot;transform&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// 用 `ts-jest` 处理 `*.ts` 文件</span>
      <span class="token property">&quot;^.+\\.tsx?$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ts-jest&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="放置测试文件-2"><a href="#放置测试文件-2" class="header-anchor">#</a> 放置测试文件</h3> <p>默认情况下，Jest 将会在整个工程里递归地找到所有的 <code>.spec.js</code> 或 <code>.test.js</code> 扩展名文件。</p> <p>我们需要改变 <code>package.json</code> 文件里的 <code>testRegex</code> 配置项以运行 <code>.ts</code> 扩展名的测试文件。</p> <p>在 <code>package.json</code> 中添加以下 <code>jest</code> 字段：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token property">&quot;testRegex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(/__tests__/.*|(\\.|/)(test|spec))\\.(jsx?|tsx?)$&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Jest 推荐我们在被测试的代码旁边创建一个 <code>__tests__</code> 目录，但你完全可以根据自己的喜好组织你的测试文件。只是要注意 Jest 会在进行截图测试的时候在测试文件旁边创建一个 <code>__snapshots__</code> 目录。</p> <h3 id="撰写一个单元测试"><a href="#撰写一个单元测试" class="header-anchor">#</a> 撰写一个单元测试</h3> <p>现在我们已经把工程设置好了，是时候撰写一个单元测试了。</p> <p>创建一个 <code>src/components/__tests__/HelloWorld.spec.ts</code> 文件，并加入如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/components/__tests__/HelloWorld.spec.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> HelloWorld <span class="token keyword">from</span> <span class="token string">'../HelloWorld.vue'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'HelloWorld.vue'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'renders props.msg when passed'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token string">'new message'</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      propsData<span class="token punctuation">:</span> <span class="token punctuation">{</span> msg <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatch</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这就是我们让 TypeScript 和 Vue Test Utils 一起工作所需要的全部工作！</p> <h3 id="相关资料-5"><a href="#相关资料-5" class="header-anchor">#</a> 相关资料</h3> <ul><li><a href="https://github.com/vuejs/vue-test-utils-typescript-example" target="_blank" rel="noopener noreferrer">该设置的示例工程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://jestjs.io/" target="_blank" rel="noopener noreferrer">Jest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="配合-vue-router-使用"><a href="#配合-vue-router-使用" class="header-anchor">#</a> 配合 Vue Router 使用</h2> <h3 id="在测试中安装-vue-router"><a href="#在测试中安装-vue-router" class="header-anchor">#</a> 在测试中安装 Vue Router</h3> <p>在测试中，你应该杜绝在基本的 Vue 构造函数中安装 Vue Router。安装 Vue Router 之后 Vue 的原型上会增加 <code>$route</code> 和 <code>$router</code> 这两个只读属性。</p> <p>为了避免这样的事情发生，我们创建了一个 <code>localVue</code> 并对其安装 Vue Router。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount<span class="token punctuation">,</span> createLocalVue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span>

<span class="token keyword">const</span> localVue <span class="token operator">=</span> <span class="token function">createLocalVue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
localVue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">shallowMount</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  localVue<span class="token punctuation">,</span>
  router
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>**注意：**在一个 <code>localVue</code> 上安装 Vue Router 时也会将 <code>$route</code> 和 <code>$router</code> 作为两个只读属性添加给该 <code>localVue</code>。这意味着如果你使用安装了 Vue Router 的 <code>localVue</code>，则不能在挂载一个组件时使用 <code>mocks</code> 选项来覆写 <code>$route</code> 和 <code>$router</code>。</p></blockquote> <h3 id="测试使用了-router-link-或-router-view-的组件"><a href="#测试使用了-router-link-或-router-view-的组件" class="header-anchor">#</a> 测试使用了 <code>router-link</code> 或 <code>router-view</code> 的组件</h3> <p>当你安装 Vue Router 的时候，<code>router-link</code> 和 <code>router-view</code> 组件就被注册了。这意味着我们无需再导入可以在应用的任意地方使用它们。</p> <p>当我们运行测试的时候，需要令 Vue Router 相关组件在我们挂载的组件中可用。有以下两种做法：</p> <h3 id="使用存根"><a href="#使用存根" class="header-anchor">#</a> 使用存根</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>

<span class="token function">shallowMount</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  stubs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'router-link'</span><span class="token punctuation">,</span> <span class="token string">'router-view'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="为-localvue-安装-vue-router"><a href="#为-localvue-安装-vue-router" class="header-anchor">#</a> 为 localVue 安装 Vue Router</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount<span class="token punctuation">,</span> createLocalVue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span>

<span class="token keyword">const</span> localVue <span class="token operator">=</span> <span class="token function">createLocalVue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
localVue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span>

<span class="token function">shallowMount</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  localVue
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="伪造-route-和-router"><a href="#伪造-route-和-router" class="header-anchor">#</a> 伪造 <code>$route</code> 和 <code>$router</code></h3> <p>有的时候你想要测试一个组件在配合 <code>$route</code> 和 <code>$router</code> 对象的参数时的行为。这时候你可以传递自定义假数据给 Vue 实例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>

<span class="token keyword">const</span> $route <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">:</span> <span class="token string">'/some/path'</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  mocks<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    $route
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

wrapper<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>$route<span class="token punctuation">.</span>path <span class="token comment">// /some/path</span>
</code></pre></div><h3 id="常识"><a href="#常识" class="header-anchor">#</a> 常识</h3> <p>安装 Vue Router 会在 Vue 的原型上添加 <code>$route</code> 和 <code>$router</code> 只读属性。</p> <p>这意味着在未来的任何测试中，伪造 <code>$route</code> 或 <code>$router</code> 都会失效。</p> <p>要想回避这个问题，就不要在运行测试的时候全局安装 Vue Router，而用上述的 <code>localVue</code> 用法。</p> <h1 id="配合-vuex-使用"><a href="#配合-vuex-使用" class="header-anchor">#</a> 配合 Vuex 使用</h1> <p>在本教程中，我们将会看到如何用 Vue Test Utils 测试组件中的 Vuex，以及如何测试一个 Vuex store。</p> <h2 id="在组件中测试-vuex"><a href="#在组件中测试-vuex" class="header-anchor">#</a> 在组件中测试 Vuex</h2> <h3 id="伪造-action"><a href="#伪造-action" class="header-anchor">#</a> 伪造 Action</h3> <p>我们来看一些代码。</p> <p>这是我们想要测试的组件。它会调用 Vuex action。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text-align-center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@input</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>actionInputIfTrue<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>actionClick()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Click<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> mapActions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>

  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token function">mapActions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'actionClick'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">actionInputIfTrue</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">actionInputIfTrue</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> inputValue <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inputValue <span class="token operator">===</span> <span class="token string">'input'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'actionInput'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> inputValue <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>站在测试的角度，我们不关心这个 action 做了什么或者这个 store 是什么样子的。我们只需要知道这些 action 将会在适当的时机触发，以及它们触发时的预期值。</p> <p>为了完成这个测试，我们需要在浅渲染组件时给 Vue 传递一个伪造的 store。</p> <p>我们可以把 store 传递给一个 <a href="/zh/api/options.html#localvue"><code>localVue</code></a>，而不是传递给基础的 Vue 构造函数。<code>localVue</code> 是一个独立作用域的 Vue 构造函数，我们可以对其进行改动而不会影响到全局的 Vue 构造函数。</p> <p>我们来看看它的样子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount<span class="token punctuation">,</span> createLocalVue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">import</span> Actions <span class="token keyword">from</span> <span class="token string">'../../../src/components/Actions'</span>

<span class="token keyword">const</span> localVue <span class="token operator">=</span> <span class="token function">createLocalVue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

localVue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Actions.vue'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> actions
  <span class="token keyword">let</span> store

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    actions <span class="token operator">=</span> <span class="token punctuation">{</span>
      actionClick<span class="token punctuation">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      actionInput<span class="token punctuation">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      state<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      actions
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'dispatches &quot;actionInput&quot; when input event value is &quot;input&quot;'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Actions<span class="token punctuation">,</span> <span class="token punctuation">{</span> store<span class="token punctuation">,</span> localVue <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> input <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span>
    input<span class="token punctuation">.</span>element<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'input'</span>
    input<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>actions<span class="token punctuation">.</span>actionInput<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'does not dispatch &quot;actionInput&quot; when event value is not &quot;input&quot;'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Actions<span class="token punctuation">,</span> <span class="token punctuation">{</span> store<span class="token punctuation">,</span> localVue <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> input <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span>
    input<span class="token punctuation">.</span>element<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'not input'</span>
    input<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>actions<span class="token punctuation">.</span>actionInput<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'calls store action &quot;actionClick&quot; when button is clicked'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Actions<span class="token punctuation">,</span> <span class="token punctuation">{</span> store<span class="token punctuation">,</span> localVue <span class="token punctuation">}</span><span class="token punctuation">)</span>
    wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>actions<span class="token punctuation">.</span>actionClick<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这里发生了什么？首先我们用 <code>localVue.use</code> 方法告诉 Vue 使用 Vuex。这只是 <code>Vue.use</code> 的一个包裹器。</p> <p>然后我们用 <code>new Vuex.Store</code> 伪造了一个 store 并填入假数据。我们只把它传递给 action，因为我们只关心这个。</p> <p>该 action 是 <a href="https://jestjs.io/docs/zh-Hans/mock-functions" target="_blank" rel="noopener noreferrer">Jest 伪造函数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。这些伪造函数让我们去断言该 action 是否被调用。</p> <p>然后我们可以在我们的测试中断言 action 存根是否如预期般被调用。</p> <p>现在我们定义 store 的方式在你看来可能有点特别。</p> <p>我们使用 <code>beforeEach</code> 来确认我们在每项测试之前已经拥有一个干净的 store。<code>beforeEach</code> 是一个 mocha 的钩子，会在每项测试之前被调用。我们在测试中会重新为 store 的变量赋值。如果我们没有这样做，伪造函数就需要被自动重置。它还需要我们改变测试中的 state，而不会影响后面的其它测试。</p> <p>该测试中最重要的注意事项是：<strong>我们创建了一个伪造的 Vuex store 并将其传递给 Vue Test Utils</strong>。</p> <p>好的，现在我们可以伪造 action 了，我们再来看看伪造 getter。</p> <h3 id="伪造-getter"><a href="#伪造-getter" class="header-anchor">#</a> 伪造 Getter</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>inputValue<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{inputValue}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>clicks<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{clicks}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> mapGetters <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>

  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    computed<span class="token punctuation">:</span> <span class="token function">mapGetters</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'clicks'</span><span class="token punctuation">,</span> <span class="token string">'inputValue'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这是一个非常简单的组件。它根据 getter <code>clicks</code> 和 <code>inputValue</code> 渲染结果。还是那句话，我们并不关注这些 getter 返回什么——只关注它们被正确的渲染。</p> <p>让我们看看这个测试：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount<span class="token punctuation">,</span> createLocalVue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">import</span> Getters <span class="token keyword">from</span> <span class="token string">'../../../src/components/Getters'</span>

<span class="token keyword">const</span> localVue <span class="token operator">=</span> <span class="token function">createLocalVue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

localVue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Getters.vue'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> getters
  <span class="token keyword">let</span> store

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    getters <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">clicks</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token function-variable function">inputValue</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'input'</span>
    <span class="token punctuation">}</span>

    store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      getters
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Renders &quot;store.getters.inputValue&quot; in first p tag'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Getters<span class="token punctuation">,</span> <span class="token punctuation">{</span> store<span class="token punctuation">,</span> localVue <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>getters<span class="token punctuation">.</span><span class="token function">inputValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Renders &quot;store.getters.clicks&quot; in second p tag'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>Getters<span class="token punctuation">,</span> <span class="token punctuation">{</span> store<span class="token punctuation">,</span> localVue <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>getters<span class="token punctuation">.</span><span class="token function">clicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这个测试和我们的 action 测试很相似。我们在每个测试运行之前创建了一个伪造的 store，在我们调用 <code>shallowMount</code> 的时候将其以一个选项传递进去，并断言我们伪造的 getter 的返回值被渲染。</p> <p>这非常好，但是如果我们想要检查我们的 getter 是否返回了正确的 state 的部分该怎么办呢？</p> <h3 id="伪造-module"><a href="#伪造-module" class="header-anchor">#</a> 伪造 Module</h3> <p><a href="https://vuex.vuejs.org/zh/guide/modules.html" target="_blank" rel="noopener noreferrer">Module<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对于将我们的 store 分隔成多个可管理的块来说非常有用。它们也暴露 getter。我们可以在测试中使用它们。</p> <p>看看这个组件：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>moduleActionClick()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Click<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{moduleClicks}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> mapActions<span class="token punctuation">,</span> mapGetters <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>

  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token function">mapActions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'moduleActionClick'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    computed<span class="token punctuation">:</span> <span class="token function">mapGetters</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'moduleClicks'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>简单的包含一个 action 和一个 getter 的组件。</p> <p>其测试：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> shallowMount<span class="token punctuation">,</span> createLocalVue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">import</span> MyComponent <span class="token keyword">from</span> <span class="token string">'../../../src/components/MyComponent'</span>
<span class="token keyword">import</span> myModule <span class="token keyword">from</span> <span class="token string">'../../../src/store/myModule'</span>

<span class="token keyword">const</span> localVue <span class="token operator">=</span> <span class="token function">createLocalVue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

localVue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'MyComponent.vue'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> actions
  <span class="token keyword">let</span> state
  <span class="token keyword">let</span> store

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span>
      clicks<span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>

    actions <span class="token operator">=</span> <span class="token punctuation">{</span>
      moduleActionClick<span class="token punctuation">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      modules<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        myModule<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          state<span class="token punctuation">,</span>
          actions<span class="token punctuation">,</span>
          getters<span class="token punctuation">:</span> myModule<span class="token punctuation">.</span>getters
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'calls store action &quot;moduleActionClick&quot; when button is clicked'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>MyComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span> store<span class="token punctuation">,</span> localVue <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> button <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span>
    button<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>actions<span class="token punctuation">.</span>moduleActionClick<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'renders &quot;state.clicks&quot; in first p tag'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallowMount</span><span class="token punctuation">(</span>MyComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span> store<span class="token punctuation">,</span> localVue <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>clicks<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="测试一个-vuex-store"><a href="#测试一个-vuex-store" class="header-anchor">#</a> 测试一个 Vuex Store</h3> <p>这里有两个测试 Vuex store 的方式。第一个方式是分别单元化测试 getter、mutation 和 action。第二个方式是创建一个 store 并针对其进行测试。我们接下来看看这两种方式如何。</p> <p>为了弄清楚如果测试一个 Vuex store，我们会创建一个简单的计数器 store。该 store 会有一个 <code>increment</code> mutation 和一个 <code>evenOrOdd</code> getter。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// mutations.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">increment</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>count<span class="token operator">++</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// getters.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">evenOrOdd</span><span class="token punctuation">:</span> <span class="token parameter">state</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>count <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">'even'</span> <span class="token punctuation">:</span> <span class="token string">'odd'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="分别测试-getter、mutation-和-action"><a href="#分别测试-getter、mutation-和-action" class="header-anchor">#</a> 分别测试 getter、mutation 和 action</h3> <p>Getter、mutation 和 action 全部是 JavaScript 函数，所以我们可以不通过 Vue Test Utils 和 Vuex 测试它们。</p> <p>分别测试 getter、mutation 和 action 的好处是你的单元测试是非常详细的。当它们失败时，你完全知道你代码的问题是什么。当然另外一方面你需要伪造诸如 <code>commit</code> 和 <code>dispatch</code> 的 Vuex 函数。这会导致在一些情况下你伪造错了东西，导致单元测试通过，生产环境的代码缺失败了。</p> <p>我们会创建两个测试文件：<code>mutations.spec.js</code> 和 <code>getters.spec.js</code>：</p> <p>首先，我们测试名为 <code>increment</code> 的 mutation：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// mutations.spec.js</span>

<span class="token keyword">import</span> mutations <span class="token keyword">from</span> <span class="token string">'./mutations'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'&quot;increment&quot; increments &quot;state.count&quot; by 1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
  mutations<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>现在让我们测试 <code>evenOrOdd</code> getter。我们可以通过创建一个伪造的 <code>state</code> 来测试它，带上 <code>state</code> 调用这个 getter 并检查它是否返回正确的结果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// getters.spec.js</span>

<span class="token keyword">import</span> getters <span class="token keyword">from</span> <span class="token string">'./getters'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'&quot;evenOrOdd&quot; returns even if &quot;state.count&quot; is even'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>getters<span class="token punctuation">.</span><span class="token function">evenOrOdd</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'even'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'&quot;evenOrOdd&quot; returns odd if &quot;state.count&quot; is odd'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>getters<span class="token punctuation">.</span><span class="token function">evenOrOdd</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'odd'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="测试一个运行中的-store"><a href="#测试一个运行中的-store" class="header-anchor">#</a> 测试一个运行中的 store</h3> <p>另一个测试 Vuex store 的方式就是使用 store 配置创建一个运行中的 store。</p> <p>这样做的好处是我们不需要伪造任何 Vuex 函数。</p> <p>另一方面当一个测试失败时，排查问题的难度会增加。</p> <p>我们来写一个测试吧。当我们创建一个 store 时，我们会使用 <code>localVue</code> 来避免污染 Vue 的基础构造函数。该测试会使用 <code>store-config.js</code> 导出的配置创建一个 store：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// store-config.js</span>

<span class="token keyword">import</span> mutations <span class="token keyword">from</span> <span class="token string">'./mutations'</span>
<span class="token keyword">import</span> getters <span class="token keyword">from</span> <span class="token string">'./getters'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token punctuation">,</span>
  getters
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// store-config.spec.js</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createLocalVue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/test-utils'</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">import</span> storeConfig <span class="token keyword">from</span> <span class="token string">'./store-config'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cloneDeep <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'increments &quot;count&quot; value when &quot;increment&quot; is commited'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> localVue <span class="token operator">=</span> <span class="token function">createLocalVue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  localVue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token function">cloneDeep</span><span class="token punctuation">(</span>storeConfig<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'increment'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'updates &quot;evenOrOdd&quot; getter when &quot;increment&quot; is commited'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> localVue <span class="token operator">=</span> <span class="token function">createLocalVue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  localVue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token function">cloneDeep</span><span class="token punctuation">(</span>storeConfig<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>evenOrOdd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'even'</span><span class="token punctuation">)</span>
  store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'increment'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>evenOrOdd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'odd'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>注意我们在创建一个 store 之前使用了 <code>cloneDeep</code> 来克隆 store 配置。这是因为 Vuex 会改变用来创建 store 的选项对象。为了确保我们能为每一个测试都提供一个干净的 store，我们需要克隆 <code>storeConfig</code> 对象。</p> <h3 id="相关资料-6"><a href="#相关资料-6" class="header-anchor">#</a> 相关资料</h3> <ul><li><a href="https://github.com/eddyerburgh/vue-test-utils-vuex-example" target="_blank" rel="noopener noreferrer">测试组件的示例工程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/eddyerburgh/testing-vuex-store-example" target="_blank" rel="noopener noreferrer">测试 store 的示例工程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="/zh/api/options.html#localvue"><code>localVue</code></a></li> <li><a href="/zh/api/createLocalVue.html"><code>createLocalVue</code></a></li></ul></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/vuejs/vue-test-utils/edit/dev/docs/zh/guides/README.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/zh/" class="prev router-link-active">
          介绍
        </a></span> <span class="next"><a href="/zh/api/">
          API
        </a>
        →
      </span></p></div> <div class="bsa-cpc-wrapper"><div class="bsa-cpc"></div></div></div> <!----></div></div>
    <script src="/assets/js/app.1329aa21.js" defer></script><script src="/assets/js/254.5765c3f9.js" defer></script>
  </body>
</html>
